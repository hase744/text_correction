<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>
<body>
    <div><input id="input_message" ></div>
    <div><input id="mending_message" ></div>
    <div><input  value="button" onclick="diplay_message()" id="button" type="button"><input  value="compare" onclick="compare_message()" id="compare" type="button"></div>
    <p id="mended_message"></p>
    <p id="output_message"></p>
</body>
<script>
    const input_message = document.getElementById("input_message");
    const button = document.getElementById("button");
    const mending_message = document.getElementById("mending_message");
    const mended_message = document.getElementById("mended_message");
    //const start = button_mending_message.selectionStart;
    //const end = button_mending_message.selectionStart;
    const cursor_change_key = ["←","↑","→","↓","Backspace"]
    const log_of_mending_message = [];
    const state_of_char = [];
    const added_char = [];
    

    function diplay_message(){
        mending_message.value = input_message.value;
        mended_message.innerHTML = input_message.value;
        log_of_mending_message.unshift(input_message.value);
        mending_message.focus();
        mending_message.setSelectionRange(input_message.value.length,input_message.value.length);
        iniput_to_state_of_char()
        console.log(log_of_mending_message);
        console.log(mending_message.selectionStart);
        console.log(input_message.selectionStart);
    }

    function display_mended_message(){
        mended_message.innerHTML = null
        for(i=0; i<state_of_char.length; i++){
            if(String(state_of_char[i][1]) == "false"){
                mended_message.innerHTML+= state_of_char[i][0].strike()
                
            }else{
                mended_message.innerHTML+= state_of_char[i][0]
            }
        }
    }

    function iniput_to_state_of_char(){
        for (let i=0; i<input_message.value.length; i++){
            let NewArray = [];
            NewArray.push(input_message.value.charAt(i));
            NewArray.push(i);
            //state_of_char.push(input_message.value.substr( i, 1 ))
            state_of_char.push(NewArray);
            //console.log(NewArray);
        }
        console.log(state_of_char);
    }

    function Backspace(){
                
                var start = mending_message.selectionStart;
                var end = mending_message.selectionStart;
                var diff_of_length = log_of_mending_message[1].length-log_of_mending_message[0].length;
                var reduced_number = log_of_mending_message[1].substr( start, diff_of_length )
                var reduced_area = -1
                console.log(state_of_char);
                for(let i=0; i<state_of_char.length; i++){
                    //falseは無視
                    console.log("state_of_char.length"+state_of_char.length)
                    if(String(state_of_char[i][1]) == "false"){
                        console.log("false")
                    //state_of_charの消す箇所の特定
                    }else if (state_of_char[i][0] == mending_message.value.charAt(state_of_char[i][1])){
                        reduced_area = i
                        console.log(state_of_char)
                        console.log(state_of_char[i][0]+"is normal")
                        //console.log(reduced_area)
                    //state_of_charの消されたところのfalse化
                    }else if(reduced_area<i && i<=reduced_area+diff_of_length){
                        state_of_char[i].splice(1,1,false)
                        console.log("made"+state_of_char[i][0]+"false")
                    //後ろを消された分だけずらす
                    }else{
                        state_of_char[i].splice(1,1,state_of_char[i][1]-diff_of_length)
                        console.log("make"+state_of_char[i]+"decrease")
                    }
                }
                display_mended_message();
    }

    function add_new_char(){
        var start = mending_message.selectionStart;
        var end = mending_message.selectionStart;
        var diff_of_length = log_of_mending_message[0].length-log_of_mending_message[1].length;
        var new_char = log_of_mending_message[0].substr(start-diff_of_length,diff_of_length );
        let NewArray = []
        NewArray.unshift(new_char)
        NewArray.unshift(start-diff_of_length)
        added_char.unshift(NewArray);
        console.log(added_char);
    }

    /*
    
    */

    document.addEventListener('keyup', (event) => {
         var start = mending_message.selectionStart;
         var end = mending_message.selectionStart;
         log_of_mending_message.unshift(mending_message.value)
         if (2<=log_of_mending_message.length){
            let diff_of_length = log_of_mending_message[1].length-log_of_mending_message[0].length;
            if (event.key == "Backspace"){
                Backspace()
         }
            if (diff_of_length<0){
                add_new_char();
            }
         }
        });

    document.addEventListener('click', (event) => {
         var start = mending_message.selectionStart;
         var end = mending_message.selectionStart;
         console.log(event.key);
         
        });
</script>
</html>
